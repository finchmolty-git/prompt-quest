<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Investment DD Scorer</title>
  <style>
    :root{--bg:#0b1020;--card:#121a2d;--line:#2a3858;--txt:#e7edf7;--muted:#9aabc7;--good:#22c55e;--med:#f59e0b;--bad:#ef4444;--acc:#38bdf8;--danger:#ef4444}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(#0a1020,#121a30);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:860px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    h1,h2,h3{margin:.2rem 0}.muted{color:var(--muted)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0d1528;font-size:.82rem}
    .q{padding:10px;border:1px solid var(--line);border-radius:10px;margin:10px 0;background:#0d1427}
    .qhead{font-weight:700;margin-bottom:6px}
    label.opt{display:block;padding:8px;border:1px solid #2e3b5f;border-radius:8px;margin:6px 0;line-height:1.3}
    input[type=radio],input[type=checkbox]{margin-right:8px}
    textarea{width:100%;background:#0b1222;color:var(--txt);border:1px solid #2e3b5f;border-radius:8px;padding:8px;min-height:56px}
    .btn{border:0;background:var(--acc);color:#032032;font-weight:700;padding:10px 12px;border-radius:10px}
    .btn.ghost{background:#1d2a44;color:var(--txt);border:1px solid #304163}
    .kpi{display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:8px}
    .kpi .card{padding:10px}
    .score{font-size:1.2rem;font-weight:800}
    .good{color:var(--good)} .med{color:var(--med)} .bad{color:var(--bad)}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
    .chip{font-size:.78rem;border:1px solid #3a4a70;border-radius:999px;padding:5px 8px;background:#0f1830}
    .chip input{margin-right:6px}
    .q.flagged{border-color:#7f1d1d;background:#1a1320}
    .danger{color:#fecaca}
    .xline{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:8px 0 4px}
    @media (max-width:640px){.grid3{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <h1>Founder Investment DD Scorer</h1>
      <span class="pill" id="qid">loading...</span>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="muted">Questionnaire</label>
      <select id="qSelect" class="pill" style="color:var(--txt);background:#0d1528"></select>
      <button class="btn ghost" id="switchQ">Load</button>
    </div>
    <div class="muted">30-question mobile assessment. Single-choice answers + optional free-text “Other”.</div>
    <div class="pill" id="activeQLabel" style="margin-top:8px;display:inline-block">Active: loading...</div>
  </div>

  <div class="card">
    <h3>Weights (configurable)</h3>
    <div class="row">
      <label>Product % <input id="wProduct" type="number" min="0" max="100"/></label>
      <label>Team % <input id="wTeam" type="number" min="0" max="100"/></label>
      <label>Vision % <input id="wVision" type="number" min="0" max="100"/></label>
      <span class="pill" id="wTotal">Total: 100</span>
    </div>
    <div class="muted">Tip: keep total = 100. If not, score auto-normalizes.</div>
  </div>

  <div class="card" id="profileCard">
    <h3>Your Investor Profile (helps tune better questions)</h3>
    <div class="muted">Answer these once. All are multi-select checkboxes. Saved locally in this browser + exportable JSON.</div>
    <div id="profileQs" style="margin-top:8px"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn ghost" id="saveProfile">Save Profile</button>
      <button class="btn ghost" id="exportProfile">Export Profile JSON</button>
      <span class="pill" id="profileState">Not saved</span>
    </div>
  </div>

  <div id="questions" class="card"></div>

  <div class="row">
    <button class="btn" id="calc">Calculate Investment Score</button>
    <button class="btn ghost" id="save">Save Response (JSON)</button>
    <button class="btn ghost" id="load">Load Last Saved</button>
  </div>

  <div id="result" class="card" style="display:none"></div>
</div>

<script>
const QUESTIONNAIRES = [
  { id:'pulseio-founder-dd-v1', label:'PulseIO Founder Investment DD', path:'./configs/pulseio-founder-dd-v1.json' },
  { id:'product-guy-join-team-v1', label:'Should I Join as Product Guy?', path:'./configs/product-guy-join-team-v1.json' },
  { id:'my-profile-fit-v1', label:'My Profile Fit Questionnaire (auto)', path:'__generated_profile__' }
];
let config;
let activeLoadToken = 0;
function questionnaireById(id){ return QUESTIONNAIRES.find(q=>q.id===id); }

const $ = id => document.getElementById(id);
const draftKey = (qid) => `investment-dd-draft-${qid}`;

function saveCurrentDraft(){
  if(!config) return;
  const payload = collect();
  localStorage.setItem(draftKey(config.id), JSON.stringify(payload));
}

function restoreDraftForCurrentConfig(){
  if(!config) return;
  const raw = localStorage.getItem(draftKey(config.id));
  if(!raw) return;
  const p = JSON.parse(raw);
  applyPayloadToUI(p);
}

function applyPayloadToUI(p){
  if(!p) return;
  if(p.weights){
    $('wProduct').value = p.weights.product ?? $('wProduct').value;
    $('wTeam').value = p.weights.team ?? $('wTeam').value;
    $('wVision').value = p.weights.vision ?? $('wVision').value;
    updateWeightTotal();
  }
  for(const a of p.answers || []){
    const radios = document.querySelectorAll(`input[name='${a.id}']`);
    for(const r of radios){ if(+r.value===+a.score && r.dataset.label===a.label){ r.checked=true; break; } }
    const t = document.getElementById('other_'+a.id); if(t) t.value = a.otherText||'';
  }
  for(const r of p.replacements || []){
    const d = document.getElementById('drop_'+r.id); if(d){ d.checked=true; document.getElementById('card_'+r.id)?.classList.add('flagged'); }
    for(const reason of (r.reasons||[])){
      const box = [...document.querySelectorAll(`input[name='xreason_${r.id}']`)].find(x=>x.value===reason);
      if(box) box.checked=true;
    }
    const n = document.getElementById('xnote_'+r.id); if(n) n.value = r.note||'';
  }
}

const replaceReasons = [
  'Too generic', 'Irrelevant to this founder', 'Duplicate/redundant', 'Too vague/unclear', 'Not investment-critical', 'Biased framing'
];

const profileQuestionsByQuestionnaire = {
  'pulseio-founder-dd-v1': [
    {id:'U1', text:'Your preferred investment stage?', options:['Pre-seed','Seed','Series A','Series B+','Stage-agnostic']},
    {id:'U2', text:'Your check style?', options:['High conviction, concentrated','Balanced portfolio','Small exploratory bets','Follow-on heavy','Unsure']},
    {id:'U3', text:'Primary investment lens?', options:['Product quality','Team quality','Market timing','Distribution/GTM','Unit economics']},
    {id:'U4', text:'Risk tolerance?', options:['Very high','High','Medium','Low','Very low']},
    {id:'U5', text:'Your role preference if you join?', options:['Hands-on product lead','Advisor only','Board-level involvement','Operator+advisor hybrid','No operating role']},
    {id:'U6', text:'Decision speed?', options:['<24h after call','2-3 days','Within a week','2+ weeks','Depends on co-investors']},
    {id:'U7', text:'Biggest red flag for you?', options:['Founder rigidity','Weak customer pull','No moat','Poor team dynamics','Messy economics']},
    {id:'U8', text:'What matters most in first 12 months?', options:['Product adoption','Revenue growth','Retention/expansion','Execution quality','Fundraising momentum']},
    {id:'U9', text:'Your current primary role background?', options:['Product Management','Founder/Operator','Engineering','Growth/Marketing','Investor only']},
    {id:'U10', text:'Years of product experience?', options:['0-2 years','3-5 years','6-10 years','11-15 years','15+ years']},
    {id:'U11', text:'Strongest product domain?', options:['B2B SaaS','Consumer','Marketplace','Developer tools','AI/ML products']},
    {id:'U12', text:'Product maturity you know best?', options:['0→1 discovery','1→10 scaling','10→100 optimization','Turnaround/rebuild','Multi-product portfolio']},
    {id:'U13', text:'Where are you strongest in product craft?', options:['Discovery & research','Roadmap/prioritization','Delivery execution','Metrics/experiments','Stakeholder alignment']},
    {id:'U14', text:'Your preferred working model with founders?', options:['Daily hands-on','Weekly strategic sync','Advisory only','Interim product lead','Depends on stage']}
  ],
  'product-guy-join-team-v1': [
    {id:'U1', text:'What role are you evaluating joining as?', options:['First Product Hire','Head of Product','Product Lead (IC+Lead)','Fractional Product Advisor','Undecided']},
    {id:'U2', text:'Years of product leadership experience?', options:['0-2 years','3-5 years','6-10 years','11-15 years','15+ years']},
    {id:'U3', text:'Your strongest product phase?', options:['0→1 discovery','1→10 scaling','10→100 optimization','Turnaround/rebuild','Multi-product portfolio']},
    {id:'U4', text:'Preferred founder collaboration style?', options:['Daily close partnership','Weekly strategic sync','As-needed advisory','Structured decision cadence','Independent with checkpoints']},
    {id:'U5', text:'Your compensation preference?', options:['Cash-heavy','Balanced cash/equity','Equity-heavy upside','Flexible by stage','Unsure']},
    {id:'U6', text:'Risk tolerance for joining early-stage teams?', options:['Very high','High','Medium','Low','Very low']},
    {id:'U7', text:'Primary reason for joining this team?', options:['Mission fit','Growth opportunity','Ownership scope','Founder/team quality','Financial upside']},
    {id:'U8', text:'What would be a hard no for you?', options:['No decision authority','Weak founder trust','Unrealistic roadmap pressure','Poor culture signals','Low upside for risk']},
    {id:'U9', text:'Domain preference?', options:['B2B SaaS','Consumer','Marketplace','Developer tools','AI/ML products']},
    {id:'U10', text:'Work model preference?', options:['Remote','Hybrid','In-person','Flexible','No preference']}
  ]
};

function currentProfileQuestions(){
  return profileQuestionsByQuestionnaire[config?.id] || profileQuestionsByQuestionnaire['pulseio-founder-dd-v1'];
}
function profileKey(){
  const qid = config?.id || 'global';
  return `investment-dd-user-profile-v1-${qid}`;
}


function getProfilePayloadByQid(qid){
  try { return JSON.parse(localStorage.getItem(`investment-dd-user-profile-v1-${qid}`) || '{}'); }
  catch { return {}; }
}

function pickOne(arr, fallback='Not specified'){
  if(Array.isArray(arr) && arr.length) return arr[0];
  return fallback;
}

function buildProfileFitQuestionnaire(){
  const join = getProfilePayloadByQid('product-guy-join-team-v1');
  const inv = getProfilePayloadByQid('pulseio-founder-dd-v1');
  const a = {...(inv.answers||{}), ...(join.answers||{})};

  const roleTarget = pickOne(a.U1, 'Product Lead');
  const expYears = pickOne(a.U2, '6-10 years');
  const phaseStrength = pickOne(a.U3, '0→1 discovery');
  const workStyle = pickOne(a.U4, 'Weekly strategic sync');
  const compPref = pickOne(a.U5, 'Balanced cash/equity');
  const risk = pickOne(a.U6, 'Medium');
  const reason = pickOne(a.U7, 'Growth opportunity');
  const hardNo = pickOne(a.U8, 'Weak founder trust');
  const domain = pickOne(a.U9, 'B2B SaaS');
  const workModel = pickOne(a.U10, 'Flexible');

  const opt5 = (best, good, ok, weak, bad) => ([
    {label:best, score:5}, {label:good, score:4}, {label:ok, score:3}, {label:weak, score:2}, {label:bad, score:1}
  ]);

  return {
    id: 'my-profile-fit-v1',
    name: 'My Profile Fit Questionnaire (Personalized)',
    description: `Auto-generated using your saved profile: role=${roleTarget}, exp=${expYears}, domain=${domain}.`,
    createdAt: new Date().toISOString().slice(0,10),
    defaultWeights: { product: 34, team: 33, vision: 33 },
    categories: ['product','team','vision'],
    questions: [
      {id:'MP1', category:'product', text:`Does this role give you real ownership as ${roleTarget}?`, options:opt5('Clear authority and ownership','Strong ownership with minor constraints','Partial ownership','Mostly delivery-only','No meaningful ownership')},
      {id:'MP2', category:'product', text:`Is the product challenge aligned with your strength in ${phaseStrength}?`, options:opt5('Strong direct alignment','Good alignment','Moderate alignment','Weak alignment','Misaligned challenge')},
      {id:'MP3', category:'product', text:`Can your ${expYears} experience materially improve product outcomes in 90 days?`, options:opt5('Very likely with clear levers','Likely with good support','Possible but uncertain','Low likelihood','No clear impact path')},
      {id:'MP4', category:'product', text:`How well does the company domain (${domain}) fit your product intuition?`, options:opt5('Excellent domain fit','Good fit','Some fit','Low fit','No fit')},
      {id:'MP5', category:'product', text:'Are key product decisions driven by evidence over opinion?', options:opt5('Strong evidence-led culture','Mostly evidence-led','Mixed decision quality','Mostly opinion-led','Chaotic decisioning')},
      {id:'MP6', category:'product', text:'Is product strategy coherent enough for you to execute effectively?', options:opt5('Very coherent','Mostly coherent','Partly coherent','Weak strategy','No strategy')},

      {id:'MT1', category:'team', text:`Can you work effectively with founders in a ${workStyle} cadence?`, options:opt5('Excellent collaboration fit','Good fit','Workable','Friction likely','High conflict risk')},
      {id:'MT2', category:'team', text:'How much trust do you have in the founders after discussions?', options:opt5('High trust','Good trust','Neutral','Some concerns','Major trust issues')},
      {id:'MT3', category:'team', text:'How healthy is cross-functional culture for product leadership?', options:opt5('Healthy and collaborative','Generally healthy','Mixed','Siloed/friction','Toxic/political')},
      {id:'MT4', category:'team', text:'How realistic are expectations on pace and scope?', options:opt5('Very realistic','Mostly realistic','Some overreach','Frequent overreach','Consistently unrealistic')},
      {id:'MT5', category:'team', text:`Does compensation setup match your preference (${compPref})?`, options:opt5('Strong fit','Good fit','Acceptable','Weak fit','Poor fit for risk')},
      {id:'MT6', category:'team', text:'Is there enough decision autonomy to avoid becoming a PM admin?', options:opt5('Strong autonomy','Good autonomy','Partial autonomy','Low autonomy','No autonomy')},

      {id:'MV1', category:'vision', text:`Given your risk tolerance (${risk}), is this opportunity risk-adjusted attractive?`, options:opt5('Very attractive','Attractive','Borderline','Unattractive','High downside')},
      {id:'MV2', category:'vision', text:`Does this role deliver your main motivation (${reason})?`, options:opt5('Strongly delivers','Mostly delivers','Partly delivers','Weakly delivers','Does not deliver')},
      {id:'MV3', category:'vision', text:`How exposed is this role to your hard-no concern (${hardNo})?`, options:opt5('No exposure','Low exposure','Moderate exposure','High exposure','Critical exposure')},
      {id:'MV4', category:'vision', text:`Is work model fit acceptable (${workModel})?`, options:opt5('Excellent fit','Good fit','Manageable','Poor fit','Deal-breaker fit')},
      {id:'MV5', category:'vision', text:'Will this role accelerate your 3–5 year trajectory?', options:opt5('Major accelerator','Strong accelerator','Moderate value','Limited value','Likely detour')},
      {id:'MV6', category:'vision', text:'Final call: based on your profile, should you join?', options:opt5('Strong yes','Yes with conditions','Maybe / gather more evidence','Likely no','No / pass')}
    ]
  };
}
function clsFor(n){ return n>=75?'good':n>=55?'med':'bad'; }
function recFor(n){ return n>=80?'Strong Invest':n>=60?'Watchlist / Conditional':'High Risk / Pass for now'; }


function renderProfile(){
  const host = $('profileQs');
  host.innerHTML = currentProfileQuestions().map(q=>`
    <div class="q" style="margin:8px 0">
      <div class="qhead">${q.id}. ${q.text}</div>
      ${q.options.map((o,i)=>`<label class="opt"><input type="checkbox" name="${q.id}" value="${o}"> ${o}</label>`).join('')}
    </div>
  `).join('');
  const raw = localStorage.getItem(profileKey());
  if(raw){
    const p = JSON.parse(raw);
    for(const [k,v] of Object.entries(p.answers||{})){
      const vals = Array.isArray(v) ? v : [v];
      for(const one of vals){
        const r = [...document.querySelectorAll(`input[name='${k}']`)].find(el => el.value === one);
        if(r) r.checked = true;
      }
    }
    $('profileState').textContent = `Saved: ${p.savedAt?.slice(0,19).replace('T',' ') || 'yes'}`;
  }
}

function collectProfile(){
  const answers = {};
  for(const q of currentProfileQuestions()){
    const sels = [...document.querySelectorAll(`input[name='${q.id}']:checked`)];
    if(sels.length) answers[q.id] = sels.map(x=>x.value);
  }
  return {version:'v1', savedAt:new Date().toISOString(), answers};
}

function wireProfileActions(){
  $('saveProfile').onclick = ()=>{
    const payload = collectProfile();
    localStorage.setItem(profileKey(), JSON.stringify(payload));
    $('profileState').textContent = `Saved: ${payload.savedAt.slice(0,19).replace('T',' ')}`;
    alert('Profile saved. I will use this to refine future questionnaires.');
  };
  $('exportProfile').onclick = ()=>{
    const payload = collectProfile();
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `investor-profile-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
    a.click(); URL.revokeObjectURL(a.href);
  };
}

async function loadConfig(path){
  const myToken = ++activeLoadToken;
  $('questions').innerHTML = '<h2>Questionnaire</h2><div class="muted">Loading…</div>';
  let nextConfig;
  if(path === '__generated_profile__'){
    nextConfig = buildProfileFitQuestionnaire();
    localStorage.setItem('investment-dd-generated-config-my-profile-fit-v1', JSON.stringify(nextConfig));
  } else {
    const r = await fetch(path, {cache:'no-store'});
    nextConfig = await r.json();
  }
  if (myToken !== activeLoadToken) return; // drop stale async load
  config = nextConfig;
  $('qid').textContent = config.id;
  $('activeQLabel').textContent = `Active: ${config.name || config.id}`;
  $('wProduct').value = config.defaultWeights.product;
  $('wTeam').value = config.defaultWeights.team;
  $('wVision').value = config.defaultWeights.vision;
  updateWeightTotal();
  renderQuestions();
  restoreDraftForCurrentConfig();
  renderProfile();
}

function updateWeightTotal(){
  const t = (+$('wProduct').value||0)+(+$('wTeam').value||0)+(+$('wVision').value||0);
  $('wTotal').textContent = `Total: ${t}`;
}
['wProduct','wTeam','wVision'].forEach(id=>$(id).addEventListener('input',()=>{updateWeightTotal();saveCurrentDraft();}));

function renderQuestions(){
  const byCat = {product:[],team:[],vision:[]};
  config.questions.forEach(q=>byCat[q.category].push(q));
  const host = $('questions');
  host.innerHTML = '<h2>Questionnaire</h2><div class="muted">Use ✕ Replace on weak questions and select why (multi-select). Those are excluded from scoring and listed for replacement.</div>';

  ['product','team','vision'].forEach(cat=>{
    const sec = document.createElement('div');
    sec.innerHTML = `<h3 style="text-transform:capitalize">${cat} (${byCat[cat].length})</h3>`;
    byCat[cat].forEach(q=>{
      const d = document.createElement('div');
      d.className='q';
      d.id = `card_${q.id}`;
      const reasonChips = replaceReasons.map((r,i)=>`<label class="chip"><input type="checkbox" name="xreason_${q.id}" value="${r}"> ${r}</label>`).join('');
      d.innerHTML = `<div class="qhead">${q.id}. ${q.text}</div>
        ${q.options.map((o)=>`<label class="opt"><input type="radio" name="${q.id}" value="${o.score}" data-label="${escapeHtml(o.label)}"> ${o.label}</label>`).join('')}
        <label class="opt"><input type="radio" name="${q.id}" value="0" data-label="Other"> Other (free text)</label>
        <textarea id="other_${q.id}" placeholder="Optional notes / other answer..."></textarea>
        <div class="xline">
          <label class="danger"><input type="checkbox" id="drop_${q.id}"> ✕ Replace this question</label>
          <span class="muted" style="font-size:.82rem">Excluded from score if checked</span>
        </div>
        <div class="chips">${reasonChips}</div>
        <textarea id="xnote_${q.id}" placeholder="Replacement guidance (optional): what should this ask instead?"></textarea>`;
      sec.appendChild(d);

      setTimeout(()=>{
        const drop = document.getElementById(`drop_${q.id}`);
        drop.addEventListener('change', ()=>{
          document.getElementById(`card_${q.id}`).classList.toggle('flagged', drop.checked);
          saveCurrentDraft();
        });
        document.querySelectorAll(`input[name="${q.id}"]`).forEach(el=>el.addEventListener('change', saveCurrentDraft));
        document.getElementById(`other_${q.id}`).addEventListener('input', saveCurrentDraft);
        document.querySelectorAll(`input[name="xreason_${q.id}"]`).forEach(el=>el.addEventListener('change', saveCurrentDraft));
        document.getElementById(`xnote_${q.id}`).addEventListener('input', saveCurrentDraft);
      },0);
    });
    host.appendChild(sec);
  });
}

function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));}

function collect(){
  const out = {
    questionnaireId: config.id,
    createdAt: new Date().toISOString(),
    weights:{product:+$('wProduct').value||0,team:+$('wTeam').value||0,vision:+$('wVision').value||0},
    answers:[],
    replacements:[]
  };

  for(const q of config.questions){
    const dropped = document.getElementById(`drop_${q.id}`).checked;
    const reasons = [...document.querySelectorAll(`input[name='xreason_${q.id}']:checked`)].map(x=>x.value);
    const xnote = document.getElementById(`xnote_${q.id}`).value.trim();

    if(dropped){
      out.replacements.push({id:q.id, category:q.category, question:q.text, reasons, note:xnote});
      continue;
    }

    const sel = document.querySelector(`input[name='${q.id}']:checked`);
    if(!sel) continue;

    out.answers.push({
      id:q.id, category:q.category, question:q.text,
      score:+sel.value,
      label:sel.dataset.label,
      otherText: document.getElementById('other_'+q.id).value.trim() || ''
    });
  }
  return out;
}

function compute(payload){
  const buckets = {product:[],team:[],vision:[]};
  for(const a of payload.answers) buckets[a.category].push(a.score);
  const avg = cat => buckets[cat].length ? (buckets[cat].reduce((x,y)=>x+y,0)/buckets[cat].length) : 0;

  const catPct = {
    product: (avg('product')/5)*100,
    team: (avg('team')/5)*100,
    vision: (avg('vision')/5)*100
  };

  const w = payload.weights;
  const totalW = (w.product+w.team+w.vision) || 1;
  const nw = {product:w.product/totalW, team:w.team/totalW, vision:w.vision/totalW};
  const weighted = (catPct.product*nw.product)+(catPct.team*nw.team)+(catPct.vision*nw.vision);

  const low = payload.answers.filter(a=>a.score<=2).slice(0,8).map(a=>`${a.id} (${a.category}): ${a.label}${a.otherText?` — ${a.otherText}`:''}`);
  return {catPct, weighted:Math.round(weighted), recommendation:recFor(weighted), risks:low};
}

function renderResult(payload, stats){
  const done = payload.answers.length;
  const total = config.questions.length;
  const removed = payload.replacements.length;

  $('result').style.display='block';
  $('result').innerHTML = `
    <h2>Investment Assessment Summary</h2>
    <div class="kpi">
      <div class="card"><div class="muted">Overall Score</div><div class="score ${clsFor(stats.weighted)}">${stats.weighted}/100</div><div>${stats.recommendation}</div></div>
      <div class="card"><div class="muted">Scored Questions</div><div class="score">${done}/${total}</div><div>${removed} marked for replacement</div></div>
    </div>

    <h3>Category Scores</h3>
    <div class="grid3">
      <div class="card"><div class="muted">Product</div><div class="score ${clsFor(stats.catPct.product)}">${Math.round(stats.catPct.product)}%</div></div>
      <div class="card"><div class="muted">Team</div><div class="score ${clsFor(stats.catPct.team)}">${Math.round(stats.catPct.team)}%</div></div>
      <div class="card"><div class="muted">Vision</div><div class="score ${clsFor(stats.catPct.vision)}">${Math.round(stats.catPct.vision)}%</div></div>
    </div>

    <h3>Top Risks (score <=2)</h3>
    <div class="card">${stats.risks.length?('<ul>'+stats.risks.map(r=>`<li>${r}</li>`).join('')+'</ul>'):'<span class="good">No major low-score risks captured.</span>'}</div>

    <h3>Questions You Marked for Replacement</h3>
    <div class="card">${payload.replacements.length ? '<ul>'+payload.replacements.map(r=>`<li><b>${r.id}</b> (${r.category}) — ${r.reasons.join(', ') || 'No reason selected'}${r.note?`<br><span class="muted">Note: ${r.note}</span>`:''}</li>`).join('')+'</ul>' : '<span class="muted">None marked.</span>'}</div>

    <h3>Recommendation Snapshot</h3>
    <div class="card">${stats.recommendation}. ${stats.weighted>=80?'High-confidence follow-up on terms and sizing.':stats.weighted>=60?'Proceed with conditions and evidence requests.':'Defer or pass unless major risks are resolved.'}</div>
  `;
}

$('calc').onclick = ()=>{
  const payload = collect();
  localStorage.setItem('investment-dd-last', JSON.stringify(payload));
  localStorage.setItem(draftKey(config.id), JSON.stringify(payload));
  const stats = compute(payload);
  renderResult(payload, stats);
  window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
};

$('save').onclick = ()=>{
  const payload = collect();
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${config.id}-response-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

$('load').onclick = ()=>{
  const raw = localStorage.getItem(draftKey(config.id)) || localStorage.getItem('investment-dd-last');
  if(!raw) return alert('No saved response found.');
  const p = JSON.parse(raw);
  applyPayloadToUI(p);
  const stats = compute(p); renderResult(p, stats);
};

function initQuestionnaireMenu(){
  const sel = $('qSelect');
  sel.innerHTML = QUESTIONNAIRES.map(q=>`<option value="${q.id}">${q.label}</option>`).join('');
  const doSwitch = async ()=>{
    saveCurrentDraft();
    $('switchQ').disabled = true;
    $('result').style.display = 'none';
    try {
      const q = questionnaireById(sel.value);
      if(!q) throw new Error('Unknown questionnaire');
      await loadConfig(q.path);
      localStorage.setItem('investment-dd-active-config', q.id);
      window.scrollTo({top:0,behavior:'smooth'});
    } catch(e){
      alert('Failed to load questionnaire: ' + e.message);
    } finally {
      $('switchQ').disabled = false;
    }
  };
  $('switchQ').onclick = doSwitch;
  sel.onchange = doSwitch;
}

wireProfileActions();

initQuestionnaireMenu();
const savedId = localStorage.getItem('investment-dd-active-config') || QUESTIONNAIRES[0].id;
$('qSelect').value = savedId;
const initial = questionnaireById(savedId) || QUESTIONNAIRES[0];
loadConfig(initial.path);
</script>
</body>
</html>
