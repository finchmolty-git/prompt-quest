<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Investment DD Scorer</title>
  <style>
    :root{--bg:#0b1020;--card:#121a2d;--line:#2a3858;--txt:#e7edf7;--muted:#9aabc7;--good:#22c55e;--med:#f59e0b;--bad:#ef4444;--acc:#38bdf8;--danger:#ef4444}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(#0a1020,#121a30);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:860px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    h1,h2,h3{margin:.2rem 0}.muted{color:var(--muted)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0d1528;font-size:.82rem}
    .q{padding:10px;border:1px solid var(--line);border-radius:10px;margin:10px 0;background:#0d1427}
    .qhead{font-weight:700;margin-bottom:6px}
    label.opt{display:block;padding:8px;border:1px solid #2e3b5f;border-radius:8px;margin:6px 0;line-height:1.3}
    input[type=radio],input[type=checkbox]{margin-right:8px}
    textarea{width:100%;background:#0b1222;color:var(--txt);border:1px solid #2e3b5f;border-radius:8px;padding:8px;min-height:56px}
    .btn{border:0;background:var(--acc);color:#032032;font-weight:700;padding:10px 12px;border-radius:10px}
    .btn.ghost{background:#1d2a44;color:var(--txt);border:1px solid #304163}
    .kpi{display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:8px}
    .kpi .card{padding:10px}
    .score{font-size:1.2rem;font-weight:800}
    .good{color:var(--good)} .med{color:var(--med)} .bad{color:var(--bad)}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
    .chip{font-size:.78rem;border:1px solid #3a4a70;border-radius:999px;padding:5px 8px;background:#0f1830}
    .chip input{margin-right:6px}
    .q.flagged{border-color:#7f1d1d;background:#1a1320}
    .danger{color:#fecaca}
    .xline{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:8px 0 4px}
    @media (max-width:640px){.grid3{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <h1>Founder Investment DD Scorer</h1>
      <span class="pill" id="qid">loading...</span>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="muted">Questionnaire</label>
      <select id="qSelect" class="pill" style="color:var(--txt);background:#0d1528"></select>
      <button class="btn ghost" id="switchQ">Load</button>
    </div>
    <div class="muted">30-question mobile assessment. Single-choice answers + optional free-text “Other”.</div>
  </div>

  <div class="card">
    <h3>Weights (configurable)</h3>
    <div class="row">
      <label>Product % <input id="wProduct" type="number" min="0" max="100"/></label>
      <label>Team % <input id="wTeam" type="number" min="0" max="100"/></label>
      <label>Vision % <input id="wVision" type="number" min="0" max="100"/></label>
      <span class="pill" id="wTotal">Total: 100</span>
    </div>
    <div class="muted">Tip: keep total = 100. If not, score auto-normalizes.</div>
  </div>

  <div class="card" id="profileCard">
    <h3>Your Investor Profile (helps tune better questions)</h3>
    <div class="muted">Answer these once. All are multiple-choice. Saved locally in this browser + exportable JSON.</div>
    <div id="profileQs" style="margin-top:8px"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn ghost" id="saveProfile">Save Profile</button>
      <button class="btn ghost" id="exportProfile">Export Profile JSON</button>
      <span class="pill" id="profileState">Not saved</span>
    </div>
  </div>

  <div id="questions" class="card"></div>

  <div class="row">
    <button class="btn" id="calc">Calculate Investment Score</button>
    <button class="btn ghost" id="save">Save Response (JSON)</button>
    <button class="btn ghost" id="load">Load Last Saved</button>
  </div>

  <div id="result" class="card" style="display:none"></div>
</div>

<script>
const QUESTIONNAIRES = [
  { id:'pulseio-founder-dd-v1', label:'PulseIO Founder Investment DD', path:'./configs/pulseio-founder-dd-v1.json' },
  { id:'product-guy-join-team-v1', label:'Should I Join as Product Guy?', path:'./configs/product-guy-join-team-v1.json' }
];
let config;

const $ = id => document.getElementById(id);
const draftKey = (qid) => `investment-dd-draft-${qid}`;

function saveCurrentDraft(){
  if(!config) return;
  const payload = collect();
  localStorage.setItem(draftKey(config.id), JSON.stringify(payload));
}

function restoreDraftForCurrentConfig(){
  if(!config) return;
  const raw = localStorage.getItem(draftKey(config.id));
  if(!raw) return;
  const p = JSON.parse(raw);
  applyPayloadToUI(p);
}

function applyPayloadToUI(p){
  if(!p) return;
  if(p.weights){
    $('wProduct').value = p.weights.product ?? $('wProduct').value;
    $('wTeam').value = p.weights.team ?? $('wTeam').value;
    $('wVision').value = p.weights.vision ?? $('wVision').value;
    updateWeightTotal();
  }
  for(const a of p.answers || []){
    const radios = document.querySelectorAll(`input[name='${a.id}']`);
    for(const r of radios){ if(+r.value===+a.score && r.dataset.label===a.label){ r.checked=true; break; } }
    const t = document.getElementById('other_'+a.id); if(t) t.value = a.otherText||'';
  }
  for(const r of p.replacements || []){
    const d = document.getElementById('drop_'+r.id); if(d){ d.checked=true; document.getElementById('card_'+r.id)?.classList.add('flagged'); }
    for(const reason of (r.reasons||[])){
      const box = [...document.querySelectorAll(`input[name='xreason_${r.id}']`)].find(x=>x.value===reason);
      if(box) box.checked=true;
    }
    const n = document.getElementById('xnote_'+r.id); if(n) n.value = r.note||'';
  }
}

const replaceReasons = [
  'Too generic', 'Irrelevant to this founder', 'Duplicate/redundant', 'Too vague/unclear', 'Not investment-critical', 'Biased framing'
];

const PROFILE_KEY = 'investment-dd-user-profile-v1';
const profileQuestions = [
  {id:'U1', text:'Your preferred investment stage?', options:['Pre-seed','Seed','Series A','Series B+','Stage-agnostic']},
  {id:'U2', text:'Your check style?', options:['High conviction, concentrated','Balanced portfolio','Small exploratory bets','Follow-on heavy','Unsure']},
  {id:'U3', text:'Primary investment lens?', options:['Product quality','Team quality','Market timing','Distribution/GTM','Unit economics']},
  {id:'U4', text:'Risk tolerance?', options:['Very high','High','Medium','Low','Very low']},
  {id:'U5', text:'Your role preference if you join?', options:['Hands-on product lead','Advisor only','Board-level involvement','Operator+advisor hybrid','No operating role']},
  {id:'U6', text:'Decision speed?', options:['<24h after call','2-3 days','Within a week','2+ weeks','Depends on co-investors']},
  {id:'U7', text:'Biggest red flag for you?', options:['Founder rigidity','Weak customer pull','No moat','Poor team dynamics','Messy economics']},
  {id:'U8', text:'What matters most in first 12 months?', options:['Product adoption','Revenue growth','Retention/expansion','Execution quality','Fundraising momentum']},
  {id:'U9', text:'Your current primary role background?', options:['Product Management','Founder/Operator','Engineering','Growth/Marketing','Investor only']},
  {id:'U10', text:'Years of product experience?', options:['0-2 years','3-5 years','6-10 years','11-15 years','15+ years']},
  {id:'U11', text:'Strongest product domain?', options:['B2B SaaS','Consumer','Marketplace','Developer tools','AI/ML products']},
  {id:'U12', text:'Product maturity you know best?', options:['0→1 discovery','1→10 scaling','10→100 optimization','Turnaround/rebuild','Multi-product portfolio']},
  {id:'U13', text:'Where are you strongest in product craft?', options:['Discovery & research','Roadmap/prioritization','Delivery execution','Metrics/experiments','Stakeholder alignment']},
  {id:'U14', text:'Your preferred working model with founders?', options:['Daily hands-on','Weekly strategic sync','Advisory only','Interim product lead','Depends on stage']}
];

function clsFor(n){ return n>=75?'good':n>=55?'med':'bad'; }
function recFor(n){ return n>=80?'Strong Invest':n>=60?'Watchlist / Conditional':'High Risk / Pass for now'; }


function renderProfile(){
  const host = $('profileQs');
  host.innerHTML = profileQuestions.map(q=>`
    <div class="q" style="margin:8px 0">
      <div class="qhead">${q.id}. ${q.text}</div>
      ${q.options.map((o,i)=>`<label class="opt"><input type="radio" name="${q.id}" value="${o}"> ${o}</label>`).join('')}
    </div>
  `).join('');
  const raw = localStorage.getItem(PROFILE_KEY);
  if(raw){
    const p = JSON.parse(raw);
    for(const [k,v] of Object.entries(p.answers||{})){
      const r = document.querySelector(`input[name='${k}'][value="${CSS.escape(v)}"]`);
      if(r) r.checked = true;
    }
    $('profileState').textContent = `Saved: ${p.savedAt?.slice(0,19).replace('T',' ') || 'yes'}`;
  }
}

function collectProfile(){
  const answers = {};
  for(const q of profileQuestions){
    const sel = document.querySelector(`input[name='${q.id}']:checked`);
    if(sel) answers[q.id] = sel.value;
  }
  return {version:'v1', savedAt:new Date().toISOString(), answers};
}

function wireProfileActions(){
  $('saveProfile').onclick = ()=>{
    const payload = collectProfile();
    localStorage.setItem(PROFILE_KEY, JSON.stringify(payload));
    $('profileState').textContent = `Saved: ${payload.savedAt.slice(0,19).replace('T',' ')}`;
    alert('Profile saved. I will use this to refine future questionnaires.');
  };
  $('exportProfile').onclick = ()=>{
    const payload = collectProfile();
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `investor-profile-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
    a.click(); URL.revokeObjectURL(a.href);
  };
}

async function loadConfig(path){
  const r = await fetch(path);
  config = await r.json();
  $('qid').textContent = config.id;
  $('wProduct').value = config.defaultWeights.product;
  $('wTeam').value = config.defaultWeights.team;
  $('wVision').value = config.defaultWeights.vision;
  updateWeightTotal();
  renderQuestions();
  restoreDraftForCurrentConfig();
}

function updateWeightTotal(){
  const t = (+$('wProduct').value||0)+(+$('wTeam').value||0)+(+$('wVision').value||0);
  $('wTotal').textContent = `Total: ${t}`;
}
['wProduct','wTeam','wVision'].forEach(id=>$(id).addEventListener('input',()=>{updateWeightTotal();saveCurrentDraft();}));

function renderQuestions(){
  const byCat = {product:[],team:[],vision:[]};
  config.questions.forEach(q=>byCat[q.category].push(q));
  const host = $('questions');
  host.innerHTML = '<h2>Questionnaire</h2><div class="muted">Use ✕ Replace on weak questions and select why (multi-select). Those are excluded from scoring and listed for replacement.</div>';

  ['product','team','vision'].forEach(cat=>{
    const sec = document.createElement('div');
    sec.innerHTML = `<h3 style="text-transform:capitalize">${cat} (${byCat[cat].length})</h3>`;
    byCat[cat].forEach(q=>{
      const d = document.createElement('div');
      d.className='q';
      d.id = `card_${q.id}`;
      const reasonChips = replaceReasons.map((r,i)=>`<label class="chip"><input type="checkbox" name="xreason_${q.id}" value="${r}"> ${r}</label>`).join('');
      d.innerHTML = `<div class="qhead">${q.id}. ${q.text}</div>
        ${q.options.map((o)=>`<label class="opt"><input type="radio" name="${q.id}" value="${o.score}" data-label="${escapeHtml(o.label)}"> ${o.label}</label>`).join('')}
        <label class="opt"><input type="radio" name="${q.id}" value="0" data-label="Other"> Other (free text)</label>
        <textarea id="other_${q.id}" placeholder="Optional notes / other answer..."></textarea>
        <div class="xline">
          <label class="danger"><input type="checkbox" id="drop_${q.id}"> ✕ Replace this question</label>
          <span class="muted" style="font-size:.82rem">Excluded from score if checked</span>
        </div>
        <div class="chips">${reasonChips}</div>
        <textarea id="xnote_${q.id}" placeholder="Replacement guidance (optional): what should this ask instead?"></textarea>`;
      sec.appendChild(d);

      setTimeout(()=>{
        const drop = document.getElementById(`drop_${q.id}`);
        drop.addEventListener('change', ()=>{
          document.getElementById(`card_${q.id}`).classList.toggle('flagged', drop.checked);
          saveCurrentDraft();
        });
        document.querySelectorAll(`input[name="${q.id}"]`).forEach(el=>el.addEventListener('change', saveCurrentDraft));
        document.getElementById(`other_${q.id}`).addEventListener('input', saveCurrentDraft);
        document.querySelectorAll(`input[name="xreason_${q.id}"]`).forEach(el=>el.addEventListener('change', saveCurrentDraft));
        document.getElementById(`xnote_${q.id}`).addEventListener('input', saveCurrentDraft);
      },0);
    });
    host.appendChild(sec);
  });
}

function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));}

function collect(){
  const out = {
    questionnaireId: config.id,
    createdAt: new Date().toISOString(),
    weights:{product:+$('wProduct').value||0,team:+$('wTeam').value||0,vision:+$('wVision').value||0},
    answers:[],
    replacements:[]
  };

  for(const q of config.questions){
    const dropped = document.getElementById(`drop_${q.id}`).checked;
    const reasons = [...document.querySelectorAll(`input[name='xreason_${q.id}']:checked`)].map(x=>x.value);
    const xnote = document.getElementById(`xnote_${q.id}`).value.trim();

    if(dropped){
      out.replacements.push({id:q.id, category:q.category, question:q.text, reasons, note:xnote});
      continue;
    }

    const sel = document.querySelector(`input[name='${q.id}']:checked`);
    if(!sel) continue;

    out.answers.push({
      id:q.id, category:q.category, question:q.text,
      score:+sel.value,
      label:sel.dataset.label,
      otherText: document.getElementById('other_'+q.id).value.trim() || ''
    });
  }
  return out;
}

function compute(payload){
  const buckets = {product:[],team:[],vision:[]};
  for(const a of payload.answers) buckets[a.category].push(a.score);
  const avg = cat => buckets[cat].length ? (buckets[cat].reduce((x,y)=>x+y,0)/buckets[cat].length) : 0;

  const catPct = {
    product: (avg('product')/5)*100,
    team: (avg('team')/5)*100,
    vision: (avg('vision')/5)*100
  };

  const w = payload.weights;
  const totalW = (w.product+w.team+w.vision) || 1;
  const nw = {product:w.product/totalW, team:w.team/totalW, vision:w.vision/totalW};
  const weighted = (catPct.product*nw.product)+(catPct.team*nw.team)+(catPct.vision*nw.vision);

  const low = payload.answers.filter(a=>a.score<=2).slice(0,8).map(a=>`${a.id} (${a.category}): ${a.label}${a.otherText?` — ${a.otherText}`:''}`);
  return {catPct, weighted:Math.round(weighted), recommendation:recFor(weighted), risks:low};
}

function renderResult(payload, stats){
  const done = payload.answers.length;
  const total = config.questions.length;
  const removed = payload.replacements.length;

  $('result').style.display='block';
  $('result').innerHTML = `
    <h2>Investment Assessment Summary</h2>
    <div class="kpi">
      <div class="card"><div class="muted">Overall Score</div><div class="score ${clsFor(stats.weighted)}">${stats.weighted}/100</div><div>${stats.recommendation}</div></div>
      <div class="card"><div class="muted">Scored Questions</div><div class="score">${done}/${total}</div><div>${removed} marked for replacement</div></div>
    </div>

    <h3>Category Scores</h3>
    <div class="grid3">
      <div class="card"><div class="muted">Product</div><div class="score ${clsFor(stats.catPct.product)}">${Math.round(stats.catPct.product)}%</div></div>
      <div class="card"><div class="muted">Team</div><div class="score ${clsFor(stats.catPct.team)}">${Math.round(stats.catPct.team)}%</div></div>
      <div class="card"><div class="muted">Vision</div><div class="score ${clsFor(stats.catPct.vision)}">${Math.round(stats.catPct.vision)}%</div></div>
    </div>

    <h3>Top Risks (score <=2)</h3>
    <div class="card">${stats.risks.length?('<ul>'+stats.risks.map(r=>`<li>${r}</li>`).join('')+'</ul>'):'<span class="good">No major low-score risks captured.</span>'}</div>

    <h3>Questions You Marked for Replacement</h3>
    <div class="card">${payload.replacements.length ? '<ul>'+payload.replacements.map(r=>`<li><b>${r.id}</b> (${r.category}) — ${r.reasons.join(', ') || 'No reason selected'}${r.note?`<br><span class="muted">Note: ${r.note}</span>`:''}</li>`).join('')+'</ul>' : '<span class="muted">None marked.</span>'}</div>

    <h3>Recommendation Snapshot</h3>
    <div class="card">${stats.recommendation}. ${stats.weighted>=80?'High-confidence follow-up on terms and sizing.':stats.weighted>=60?'Proceed with conditions and evidence requests.':'Defer or pass unless major risks are resolved.'}</div>
  `;
}

$('calc').onclick = ()=>{
  const payload = collect();
  localStorage.setItem('investment-dd-last', JSON.stringify(payload));
  localStorage.setItem(draftKey(config.id), JSON.stringify(payload));
  const stats = compute(payload);
  renderResult(payload, stats);
  window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
};

$('save').onclick = ()=>{
  const payload = collect();
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${config.id}-response-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

$('load').onclick = ()=>{
  const raw = localStorage.getItem(draftKey(config.id)) || localStorage.getItem('investment-dd-last');
  if(!raw) return alert('No saved response found.');
  const p = JSON.parse(raw);
  applyPayloadToUI(p);
  const stats = compute(p); renderResult(p, stats);
};

function initQuestionnaireMenu(){
  const sel = $('qSelect');
  sel.innerHTML = QUESTIONNAIRES.map(q=>`<option value="${q.path}">${q.label}</option>`).join('');
  $('switchQ').onclick = async ()=>{
    saveCurrentDraft();
    await loadConfig(sel.value);
    localStorage.setItem('investment-dd-active-config', sel.value);
    window.scrollTo({top:0,behavior:'smooth'});
  };
}

renderProfile();
wireProfileActions();

initQuestionnaireMenu();
const saved = localStorage.getItem('investment-dd-active-config') || QUESTIONNAIRES[0].path;
$('qSelect').value = saved;
loadConfig(saved);
</script>
</body>
</html>
